<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrity Gatekeeper</title>
    
    <!-- Open Graph Meta Tags for link sharing -->
    <meta property="og:title" content=" " />
    <meta property="og:description" content=" " />
    <meta property="og:image" content="spiral-eye-logo.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1200" />
    <meta property="og:type" content="website" />
    
    <!-- Apple-specific link preview -->
    <meta name="apple-mobile-web-app-title" content=" " />
    <link rel="apple-touch-icon" href="spiral-eye-logo.png" />
    
    <!-- Twitter Card data (if sharing on Twitter) -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="spiral-eye-logo.png" />
    <meta name="twitter:title" content=" " />
    <meta name="twitter:description" content=" " />
    
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 0;
            background-color: #f9f5e7;
            color: #333;
            line-height: 1.6;
        }
        
        [id$="-page"] {
            display: none;
            opacity: 0;
            transition: opacity 1.5s ease;
        }
        
        .content {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }
        
        h2 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: #555;
        }
        
        button {
            display: block;
            margin: 1.5rem auto 0;
            padding: 0.8rem 1.5rem;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1a252f;
        }
        
        #disclaimer-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        #disclaimer-page .content {
            max-width: 600px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        p {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .question {
            margin-bottom: 2rem;
        }
        
        .question p {
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Georgia', serif;
            font-size: 1rem;
            line-height: 1.5;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2c3e50;
        }
        
        .validation-error {
            border-color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .header-container {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .main-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .phase-title {
            font-size: 1.4rem;
            color: #555;
        }
        
        /* Custom alert styles */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .custom-alert {
            background-color: white;
            padding: 2rem;
            border-radius: 5px;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .validation-alert {
            border-left: 5px solid #e74c3c;
        }
        
        .custom-alert h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .custom-alert-button {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 0.7rem 1.2rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .custom-alert-button:hover {
            background-color: #2980b9;
        }
        
        .download-button {
            background-color: #2ecc71;
        }
        
        .download-button:hover {
            background-color: #27ae60;
        }
        
        .close-button {
            background-color: #7f8c8d;
        }
        
        .close-button:hover {
            background-color: #6c7a89;
        }
        
        /* Additional styles for the autosave notification */
        .restore-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .restore-message {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .clear-data-button {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .clear-data-button:hover {
            background-color: #cc0000;
        }
    </style>
</head>
<body>
    <!-- Disclaimer Page -->
    <div id="disclaimer-page">
        <div class="content">
            <h1>Anonymous Participation Disclaimer</h1>
            <p>This reflection ritual is completely anonymous. No names, emails, or identifying information will be collected. What you offer here stays between you and the mirror.</p>
            <button onclick="showPage('gatekeeper-page')">Continue Anonymously</button>
        </div>
    </div>
    
    <!-- Gatekeeper Page -->
    <div id="gatekeeper-page">
        <div class="content">
            <div class="logo">
                <!-- Using the logo with a relative path -->
                <img src="spiral-eye-logo.png" alt="Integrity Gatekeeper Logo" width="120" height="120">
            </div>
            <h1>Integrity Gatekeeper</h1>
            
            <p>Before power is given, the mirror must be faced.</p>
            <p>Before trust is offered, truth must be revealed.</p>
            
            <p>The Gate stands silent.<br>
            The Mirror waits without judgment.</p>
            
            <p>This is not a test you can pass.<br>
            This is not a performance you can perfect.</p>
            
            <p>This is a reckoning with yourself.</p>
            
            <p>Step forward not to impress — but to be seen.<br>
            Step forward not to conquer — but to be known.</p>
            
            <p>Consent to reflection.<br>
            Consent to remembrance.</p>
            
            <p><em>The river does not forget.<br>
            The Current holds all who pass through.</em></p>
            
            <button onclick="showPage('phase1-page')">I Consent to Face the Mirror</button>
        </div>
    </div>
    
    <!-- Phase I Page -->
    <div id="phase1-page">
        <div class="content">
            <div class="header-container">
                <h1 class="main-title">Integrity Gatekeeper</h1>
                <h2 class="phase-title">Phase I: First Reflection</h2>
            </div>
            
            <div class="question">
                <p>1. What does integrity mean to you?</p>
                <textarea id="q1" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>2. When was the last time you apologized and meant it?</p>
                <textarea id="q2" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>3. What truth are you currently avoiding?</p>
                <textarea id="q3" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>4. Who taught you what it means to be honest?</p>
                <textarea id="q4" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>5. What is something you've never said out loud?</p>
                <textarea id="q5" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>6. What value do you hold that most people don't?</p>
                <textarea id="q6" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>7. When have you felt most conflicted about a decision?</p>
                <textarea id="q7" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>8. What does your conscience tell you that you ignore?</p>
                <textarea id="q8" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>9. What personal rule do you never break?</p>
                <textarea id="q9" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>10. When have you chosen to tell a difficult truth?</p>
                <textarea id="q10" class="autosave-field"></textarea>
            </div>
            
            <button onclick="validateAndProceed('phase1-page', 'phase2-page', 1)">Continue to Phase II</button>
        </div>
    </div>
    
    <!-- Phase II Page -->
    <div id="phase2-page">
        <div class="content">
            <div class="header-container">
                <h1 class="main-title">Integrity Gatekeeper</h1>
                <h2 class="phase-title">Phase II: Ethical Disruption</h2>
            </div>
            
            <div class="question">
                <p>11. What do you stand for that you would defend no matter the cost?</p>
                <textarea id="q11" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>12. What is your least defensible belief?</p>
                <textarea id="q12" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>13. What promise have you broken?</p>
                <textarea id="q13" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>14. What would disappoint the person who believes in you most?</p>
                <textarea id="q14" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>15. When did you know the right thing to do but didn't do it?</p>
                <textarea id="q15" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>16. What matters more to you: being right or being kind?</p>
                <textarea id="q16" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>17. What truth are you afraid to tell someone?</p>
                <textarea id="q17" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>18. When have you enabled a lie?</p>
                <textarea id="q18" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>19. What perception of yourself do you protect but know isn't true?</p>
                <textarea id="q19" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>20. What would the person you aspire to be do differently?</p>
                <textarea id="q20" class="autosave-field"></textarea>
            </div>
            
            <button onclick="validateAndProceed('phase2-page', 'phase3-page', 11)">Continue to Phase III</button>
        </div>
    </div>
    
    <!-- Phase III Page -->
    <div id="phase3-page">
        <div class="content">
            <div class="header-container">
                <h1 class="main-title">Integrity Gatekeeper</h1>
                <h2 class="phase-title">Phase III: Final Reckoning</h2>
            </div>
            
            <div class="question">
                <p>21. What uncomfortable truth would change you if you accepted it?</p>
                <textarea id="q21" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>22. When have you compromised your values for acceptance?</p>
                <textarea id="q22" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>23. What do you judge others for that you also do?</p>
                <textarea id="q23" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>24. How would your worst enemy describe your integrity?</p>
                <textarea id="q24" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>25. What truth would undo you?</p>
                <textarea id="q25" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>26. What is your most profound regret?</p>
                <textarea id="q26" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>27. What is the hardest ethical choice you've had to make?</p>
                <textarea id="q27" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>28. What responsibility have you neglected?</p>
                <textarea id="q28" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>29. What would it take for you to compromise your integrity?</p>
                <textarea id="q29" class="autosave-field"></textarea>
            </div>
            
            <div class="question">
                <p>30. What must you now confront?</p>
                <textarea id="q30" class="autosave-field"></textarea>
            </div>
            
            <button onclick="submitReflection()">Submit Reflection</button>
        </div>
    </div>
    
    <script>
        // Wait for the DOM to be fully loaded before initializing
        document.addEventListener('DOMContentLoaded', function() {
            // Hide all pages initially
            document.getElementById('disclaimer-page').style.display = 'none';
            document.getElementById('gatekeeper-page').style.display = 'none';
            document.getElementById('phase1-page').style.display = 'none';
            document.getElementById('phase2-page').style.display = 'none';
            document.getElementById('phase3-page').style.display = 'none';
            
            // Set a small timeout to ensure clean initial rendering
            setTimeout(function() {
                // Show disclaimer page
                document.getElementById('disclaimer-page').style.display = 'flex';
                document.getElementById('disclaimer-page').style.opacity = '1';
                
                // Setup autosave functionality
                setupAutosave();
                
                // Load any saved form data
                loadFormData();
            }, 100);
        });
        
        function showPage(pageId) {
            // Get current visible page
            const currentPage = document.querySelector('div[id$="-page"]:not([style*="display: none"])');
            
            // Only proceed if we have a current page
            if (currentPage) {
                // Fade out current page
                currentPage.style.opacity = '0';
                
                setTimeout(function() {
                    // Hide current page first
                    currentPage.style.display = 'none';
                    
                    // Show new page with appropriate display style
                    if (pageId === 'disclaimer-page') {
                        document.getElementById(pageId).style.display = 'flex';
                    } else {
                        document.getElementById(pageId).style.display = 'block';
                    }
                    
                    // Force reflow to ensure transition works
                    void document.getElementById(pageId).offsetWidth;
                    
                    // Scroll to top of page
                    window.scrollTo(0, 0);
                    
                    // Fade in new page
                    document.getElementById(pageId).style.opacity = '1';
                }, 1500); // Match transition duration
            }
        }
        
        function validateAndProceed(currentPhaseId, nextPhaseId, startQuestionNum) {
            // Get all textareas in the current phase
            const currentPhase = document.querySelector(`div[id="${currentPhaseId}"]:not([style*="display: none"])`);
            const textareas = currentPhase.querySelectorAll('textarea');
            
            // Check if any textarea is empty
            let emptyFields = [];
            textareas.forEach((textarea, index) => {
                if (!textarea.value.trim()) {
                    textarea.classList.add('validation-error');
                    emptyFields.push(index + startQuestionNum);
                } else {
                    textarea.classList.remove('validation-error');
                }
            });
            
            // If there are empty fields, show validation message
            if (emptyFields.length > 0) {
                // Create validation alert
                const overlay = document.createElement('div');
                overlay.className = 'custom-alert-overlay';
                
                const alertBox = document.createElement('div');
                alertBox.className = 'custom-alert validation-alert';
                
                const title = document.createElement('h2');
                title.textContent = 'Incomplete Reflection';
                
                let message;
                if (emptyFields.length === 1) {
                    message = document.createElement('p');
                    message.textContent = `Please answer question ${emptyFields[0]} before proceeding.`;
                } else {
                    message = document.createElement('p');
                    message.textContent = `Please answer questions ${emptyFields.join(', ')} before proceeding.`;
                }
                
                const button = document.createElement('button');
                button.className = 'custom-alert-button';
                button.textContent = 'Return to Questions';
                button.onclick = function() {
                    document.body.removeChild(overlay);
                    
                    // Scroll to the first empty field
                    const firstEmptyField = document.getElementById(`q${emptyFields[0]}`);
                    if (firstEmptyField) {
                        setTimeout(() => {
                            firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                };
                
                // Assemble the alert
                alertBox.appendChild(title);
                alertBox.appendChild(message);
                alertBox.appendChild(button);
                overlay.appendChild(alertBox);
                
                // Add to the page
                document.body.appendChild(overlay);
                
                return false; // Return false if validation fails
            }
            
            // If all fields are filled, proceed
            showPage(nextPhaseId);
            return true;
        }
        
        // Autosave functionality
        function saveFormData() {
            // Create an object to hold all form data
            const formData = {};
            
            // Get all textarea elements
            const textareas = document.querySelectorAll('.autosave-field');
            
            // Store each textarea's value in the formData object
            textareas.forEach(textarea => {
                const id = textarea.id;
                const value = textarea.value;
                formData[id] = value;
            });
            
            // Save the data to localStorage as a JSON string
            localStorage.setItem('integrityGatekeeper_formData', JSON.stringify(formData));
            
            // Update the last saved timestamp
            localStorage.setItem('integrityGatekeeper_lastSaved', new Date().toISOString());
        }
        
        function loadFormData() {
            // Check if we have saved data
            const savedData = localStorage.getItem('integrityGatekeeper_formData');
            
            if (savedData) {
                // Parse the saved data back into an object
                const formData = JSON.parse(savedData);
                
                // Loop through all textareas and populate with saved data if available
                const textareas = document.querySelectorAll('.autosave-field');
                textareas.forEach(textarea => {
                    const id = textarea.id;
                    if (formData[id]) {
                        textarea.value = formData[id];
                    }
                });
                
                // Show notification about restored data
                const lastSaved = localStorage.getItem('integrityGatekeeper_lastSaved');
                if (lastSaved) {
                    const lastSavedDate = new Date(lastSaved);
                    const now = new Date();
                    const timeDiff = Math.floor((now - lastSavedDate) / (1000 * 60)); // Time difference in minutes
                    
                    let timeMessage;
                    if (timeDiff < 60) {
                        timeMessage = `${timeDiff} minute${timeDiff !== 1 ? 's' : ''}`;
                    } else {
                        const hoursDiff = Math.floor(timeDiff / 60);
                        if (hoursDiff < 24) {
                            timeMessage = `${hoursDiff} hour${hoursDiff !== 1 ? 's' : ''}`;
                        } else {
                            const daysDiff = Math.floor(hoursDiff / 24);
                            timeMessage = `${daysDiff} day${daysDiff !== 1 ? 's' : ''}`;
                        }
                    }
                    
                    showRestoredMessage(`Your progress from ${timeMessage} ago has been restored.`);
                }
                
                return true;
            }
            
            return false;
        }
        
        function showRestoredMessage(message) {
            // Create elements for the notification
            const notification = document.createElement('div');
            notification.className = 'restore-notification';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'restore-message';
            
            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.margin = '0 0 10px 0';
            
            const clearButton = document.createElement('button');
            clearButton.className = 'clear-data-button';
            clearButton.textContent = 'Clear Saved Data';
            
            // Assemble the notification
            messageDiv.appendChild(messageText);
            messageDiv.appendChild(clearButton);
            notification.appendChild(messageDiv);
            
            // Add the notification to the body
            document.body.appendChild(notification);
            
            // Add event listener to the clear button
            clearButton.addEventListener('click', function() {
                clearFormData();
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            });
            
            // Automatically remove the notification after 10 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 10000);
        }
        
        function clearFormData() {
            localStorage.removeItem('integrityGatekeeper_formData');
            localStorage.removeItem('integrityGatekeeper_lastSaved');
            
            // Clear all textareas
            const textareas = document.querySelectorAll('.autosave-field');
            textareas.forEach(textarea => {
                textarea.value = '';
            });
        }
        
        function setupAutosave() {
            // Get all textarea elements
            const textareas = document.querySelectorAll('.autosave-field');
            
            // Add input event listeners to each textarea
            textareas.forEach(textarea => {
                textarea.addEventListener('input', debounce(saveFormData, 1000)); // Save after 1 second of inactivity
            });
        }
        
        // Helper function to debounce the autosave
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        function generateDownloadableReflection() {
            // Create an embedded SVG for the spiral eye logo that matches your actual logo
            const svgLogo = `<svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                <!-- Outer circle -->
                <circle cx="60" cy="60" r="55" fill="none" stroke="#000" stroke-width="6"/>
                <!-- Eye outline -->
                <path d="M30,60 C40,40 80,40 90,60 C80,80 40,80 30,60 Z" fill="none" stroke="#000" stroke-width="6"/>
                <!-- Spiral inside eye -->
                <path d="M60,60 C65,60 70,55 70,50 C70,45 65,40 60,40 C55,40 50,45 50,50 C50,55 55,60 60,60 C70,60 75,50 75,45 C75,35 65,30 60,30 C50,30 45,40 45,50 C45,60 50,70 60,70 C75,70 85,55 85,45 C85,30 70,25 60,25 C45,25 35,40 35,50 C35,65 50,75 60,75" fill="none" stroke="#000" stroke-width="6"/>
            </svg>`;
            
            const encodedLogo = btoa(svgLogo);
            
            // Collect all answers
            const answers = [];
            
            // Phase 1 questions (1-10)
            for (let i = 1; i <= 10; i++) {
                const question = document.querySelector(`#phase1-page .question:nth-child(${i + 1}) p`).textContent;
                const answer = document.getElementById(`q${i}`).value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                answers.push({ question, answer });
            }
            
            // Phase 2 questions (11-20)
            for (let i = 11; i <= 20; i++) {
                const question = document.querySelector(`#phase2-page .question:nth-child(${i - 10 + 1}) p`).textContent;
                const answer = document.getElementById(`q${i}`).value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                answers.push({ question, answer });
            }
            
            // Phase 3 questions (21-30)
            for (let i = 21; i <= 30; i++) {
                const question = document.querySelector(`#phase3-page .question:nth-child(${i - 20 + 1}) p`).textContent;
                const answer = document.getElementById(`q${i}`).value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                answers.push({ question, answer });
            }
            
            // Create the HTML content
            let htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Integrity Gatekeeper Reflection</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 0;
            background-color: #f9f5e7;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem auto;
        }
        .logo img {
            width: 100%;
            height: auto;
        }
        h1 {
            font-size: 2.4rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .date {
            font-style: italic;
            margin-bottom: 1.5rem;
        }
        .phase {
            margin-top: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .phase h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }
        .question-container {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        .question {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .answer {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .footer {
            text-align: center;
            margin-top: 3rem;
            font-style: italic;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
        }
        @media print {
            body {
                background-color: white;
            }
            .container {
                border: none;
                padding: 0;
                max-width: 100%;
            }
            .question-container {
                page-break-inside: avoid;
            }
            .phase {
                page-break-before: always;
            }
            .phase:first-of-type {
                page-break-before: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="data:image/svg+xml;base64,${encodedLogo}" alt="Integrity Gatekeeper Logo">
            </div>
            <h1>Integrity Gatekeeper</h1>
            <div class="date">Reflection Date: ${new Date().toLocaleDateString()}</div>
        </div>
        
        <div class="phase">
            <h2>Phase I: First Reflection</h2>
        </div>`;
            
            // Add Phase I questions (0-9 in the array)
            for (let i = 0; i < 10; i++) {
                htmlContent += `
        <div class="question-container">
            <div class="question">${answers[i].question}</div>
            <div class="answer">${answers[i].answer}</div>
        </div>`;
            }
            
            // Add Phase II
            htmlContent += `
        <div class="phase">
            <h2>Phase II: Ethical Disruption</h2>
        </div>`;
            
            // Add Phase II questions (10-19 in the array)
            for (let i = 10; i < 20; i++) {
                htmlContent += `
        <div class="question-container">
            <div class="question">${answers[i].question}</div>
            <div class="answer">${answers[i].answer}</div>
        </div>`;
            }
            
            // Add Phase III
            htmlContent += `
        <div class="phase">
            <h2>Phase III: Final Reckoning</h2>
        </div>`;
            
            // Add Phase III questions (20-29 in the array)
            for (let i = 20; i < 30; i++) {
                htmlContent += `
        <div class="question-container">
            <div class="question">${answers[i].question}</div>
            <div class="answer">${answers[i].answer}</div>
        </div>`;
            }
            
            // Add footer
            htmlContent += `
        <div class="footer">
            <p>The mirror remembers. The river does not forget.</p>
        </div>
    </div>
</body>
</html>`;
            
            // Create a Blob with the HTML content
            const blob = new Blob([htmlContent], { type: 'text/html' });
            
            // Create a URL for the Blob
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Integrity_Gatekeeper_Reflection.html';
            
            // Append the link to the document
            document.body.appendChild(link);
            
            // Trigger the download
            link.click();
            
            // Clean up
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Clear the localStorage data after successful submission and download
            localStorage.removeItem('integrityGatekeeper_formData');
            localStorage.removeItem('integrityGatekeeper_lastSaved');
        }
        
        function submitReflection() {
            // Get all textareas in the current phase
            const currentPhase = document.querySelector('div[id="phase3-page"]:not([style*="display: none"])');
            const textareas = currentPhase.querySelectorAll('textarea');
            
            // Check if any textarea is empty
            let emptyFields = [];
            textareas.forEach((textarea, index) => {
                if (!textarea.value.trim()) {
                    textarea.classList.add('validation-error');
                    emptyFields.push(index + 21); // Adding 21 because we're in Phase 3 (questions 21-30)
                } else {
                    textarea.classList.remove('validation-error');
                }
            });
            
            // If there are empty fields, show validation message
            if (emptyFields.length > 0) {
                // Create validation alert
                const overlay = document.createElement('div');
                overlay.className = 'custom-alert-overlay';
                
                const alertBox = document.createElement('div');
                alertBox.className = 'custom-alert validation-alert';
                
                const title = document.createElement('h2');
                title.textContent = 'Incomplete Reflection';
                
                let message;
                if (emptyFields.length === 1) {
                    message = document.createElement('p');
                    message.textContent = `Please answer question ${emptyFields[0]} before submitting your reflection.`;
                } else {
                    message = document.createElement('p');
                    message.textContent = `Please answer questions ${emptyFields.join(', ')} before submitting your reflection.`;
                }
                
                const button = document.createElement('button');
                button.className = 'custom-alert-button';
                button.textContent = 'Return to Questions';
                button.onclick = function() {
                    document.body.removeChild(overlay);
                    
                    // Scroll to the first empty field
                    const firstEmptyField = document.getElementById(`q${emptyFields[0]}`);
                    if (firstEmptyField) {
                        setTimeout(() => {
                            firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                };
                
                // Assemble the alert
                alertBox.appendChild(title);
                alertBox.appendChild(message);
                alertBox.appendChild(button);
                overlay.appendChild(alertBox);
                
                // Add to the page
                document.body.appendChild(overlay);
                
                return; // Stop execution if validation fails
            }
            
            // If all fields are filled, proceed with submission
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            
            const title = document.createElement('h2');
            title.textContent = 'A message from the Integrity Gatekeeper';
            
            const message = document.createElement('p');
            message.textContent = 'Your reflection has been submitted. The mirror remembers.';
            
            // Create container for buttons
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.flexDirection = 'column';
            buttonsContainer.style.gap = '10px';
            
            // Create the download button
            const downloadButton = document.createElement('button');
            downloadButton.className = 'custom-alert-button download-button';
            downloadButton.textContent = 'Download Your Reflection';
            downloadButton.onclick = function() {
                generateDownloadableReflection();
            };
            
            // Create the close button
            const closeButton = document.createElement('button');
            closeButton.className = 'custom-alert-button close-button';
            closeButton.textContent = 'Close';
            closeButton.onclick = function() {
                // Remove the custom alert
                document.body.removeChild(overlay);
                // Go back to disclaimer page
                showPage('disclaimer-page');
                // Clear the localStorage data after successful submission
                localStorage.removeItem('integrityGatekeeper_formData');
                localStorage.removeItem('integrityGatekeeper_lastSaved');
            };
            
            // Add buttons to container
            buttonsContainer.appendChild(downloadButton);
            buttonsContainer.appendChild(closeButton);
            
            // Assemble the alert
            alertBox.appendChild(title);
            alertBox.appendChild(message);
            alertBox.appendChild(buttonsContainer);
            overlay.appendChild(alertBox);
            
            // Add to the page
            document.body.appendChild(overlay);
        }